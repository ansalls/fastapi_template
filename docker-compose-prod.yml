services:
  api:
    image: ${API_IMAGE:-sloppynetworks/fastapi-app:latest}
    ports:
      - "80:8000"
    environment:
      DATABASE_HOSTNAME: ${DATABASE_HOSTNAME}
      DATABASE_PORT: ${DATABASE_PORT}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      DATABASE_NAME: ${DATABASE_NAME}
      DATABASE_USERNAME: ${DATABASE_USERNAME}
      SECRET_KEY: ${SECRET_KEY}
      ALGORITHM: ${ALGORITHM}
      TOKEN_ISSUER: ${TOKEN_ISSUER:-fastapi-template}
      TOKEN_AUDIENCE: ${TOKEN_AUDIENCE:-fastapi-template-api}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES}
      REDIS_URL: ${REDIS_URL}
      TRUST_PROXY_HEADERS: ${TRUST_PROXY_HEADERS:-false}
      TRUSTED_HOSTS: '${TRUSTED_HOSTS:-["localhost","127.0.0.1","testserver"]}'
      SECURITY_HEADERS_ENABLED: ${SECURITY_HEADERS_ENABLED:-true}
      SECURITY_CSP_ENABLED: ${SECURITY_CSP_ENABLED:-true}
      SECURITY_HSTS_ENABLED: ${SECURITY_HSTS_ENABLED:-false}
      SECURITY_HSTS_MAX_AGE_SECONDS: ${SECURITY_HSTS_MAX_AGE_SECONDS:-31536000}
      SECURITY_HTTPS_REDIRECT: ${SECURITY_HTTPS_REDIRECT:-false}
      ENABLE_OPTIONAL_BACKGROUND_JOBS: ${ENABLE_OPTIONAL_BACKGROUND_JOBS:-true}
      OUTBOX_DISPATCH_BATCH_SIZE: ${OUTBOX_DISPATCH_BATCH_SIZE:-100}
      OUTBOX_RETRY_MAX_ATTEMPTS: ${OUTBOX_RETRY_MAX_ATTEMPTS:-5}
      OUTBOX_RETRY_BACKOFF_SECONDS: ${OUTBOX_RETRY_BACKOFF_SECONDS:-30}
      OUTBOX_DISPATCH_INTERVAL_SECONDS: ${OUTBOX_DISPATCH_INTERVAL_SECONDS:-15}
      OAUTH_PUBLIC_BASE_URL: ${OAUTH_PUBLIC_BASE_URL:-}
      OAUTH_FRONTEND_CALLBACK_URL: ${OAUTH_FRONTEND_CALLBACK_URL:-/}
      OAUTH_GOOGLE_CLIENT_ID: ${OAUTH_GOOGLE_CLIENT_ID:-}
      OAUTH_GOOGLE_CLIENT_SECRET: ${OAUTH_GOOGLE_CLIENT_SECRET:-}
      OAUTH_MICROSOFT_CLIENT_ID: ${OAUTH_MICROSOFT_CLIENT_ID:-}
      OAUTH_MICROSOFT_CLIENT_SECRET: ${OAUTH_MICROSOFT_CLIENT_SECRET:-}
      OAUTH_APPLE_CLIENT_ID: ${OAUTH_APPLE_CLIENT_ID:-}
      OAUTH_APPLE_CLIENT_SECRET: ${OAUTH_APPLE_CLIENT_SECRET:-}
      OAUTH_FACEBOOK_CLIENT_ID: ${OAUTH_FACEBOOK_CLIENT_ID:-}
      OAUTH_FACEBOOK_CLIENT_SECRET: ${OAUTH_FACEBOOK_CLIENT_SECRET:-}
      OAUTH_GITHUB_CLIENT_ID: ${OAUTH_GITHUB_CLIENT_ID:-}
      OAUTH_GITHUB_CLIENT_SECRET: ${OAUTH_GITHUB_CLIENT_SECRET:-}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started

  worker:
    image: ${API_IMAGE:-sloppynetworks/fastapi-app:latest}
    environment:
      DATABASE_HOSTNAME: ${DATABASE_HOSTNAME}
      DATABASE_PORT: ${DATABASE_PORT}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      DATABASE_NAME: ${DATABASE_NAME}
      DATABASE_USERNAME: ${DATABASE_USERNAME}
      SECRET_KEY: ${SECRET_KEY}
      ALGORITHM: ${ALGORITHM}
      TOKEN_ISSUER: ${TOKEN_ISSUER:-fastapi-template}
      TOKEN_AUDIENCE: ${TOKEN_AUDIENCE:-fastapi-template-api}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES}
      REDIS_URL: ${REDIS_URL}
      TRUST_PROXY_HEADERS: ${TRUST_PROXY_HEADERS:-false}
      TRUSTED_HOSTS: '${TRUSTED_HOSTS:-["localhost","127.0.0.1","testserver"]}'
      ENABLE_OPTIONAL_BACKGROUND_JOBS: ${ENABLE_OPTIONAL_BACKGROUND_JOBS:-true}
      OUTBOX_DISPATCH_BATCH_SIZE: ${OUTBOX_DISPATCH_BATCH_SIZE:-100}
      OUTBOX_RETRY_MAX_ATTEMPTS: ${OUTBOX_RETRY_MAX_ATTEMPTS:-5}
      OUTBOX_RETRY_BACKOFF_SECONDS: ${OUTBOX_RETRY_BACKOFF_SECONDS:-30}
      OUTBOX_DISPATCH_INTERVAL_SECONDS: ${OUTBOX_DISPATCH_INTERVAL_SECONDS:-15}
      OAUTH_PUBLIC_BASE_URL: ${OAUTH_PUBLIC_BASE_URL:-}
      OAUTH_FRONTEND_CALLBACK_URL: ${OAUTH_FRONTEND_CALLBACK_URL:-/}
      OAUTH_GOOGLE_CLIENT_ID: ${OAUTH_GOOGLE_CLIENT_ID:-}
      OAUTH_GOOGLE_CLIENT_SECRET: ${OAUTH_GOOGLE_CLIENT_SECRET:-}
      OAUTH_MICROSOFT_CLIENT_ID: ${OAUTH_MICROSOFT_CLIENT_ID:-}
      OAUTH_MICROSOFT_CLIENT_SECRET: ${OAUTH_MICROSOFT_CLIENT_SECRET:-}
      OAUTH_APPLE_CLIENT_ID: ${OAUTH_APPLE_CLIENT_ID:-}
      OAUTH_APPLE_CLIENT_SECRET: ${OAUTH_APPLE_CLIENT_SECRET:-}
      OAUTH_FACEBOOK_CLIENT_ID: ${OAUTH_FACEBOOK_CLIENT_ID:-}
      OAUTH_FACEBOOK_CLIENT_SECRET: ${OAUTH_FACEBOOK_CLIENT_SECRET:-}
      OAUTH_GITHUB_CLIENT_ID: ${OAUTH_GITHUB_CLIENT_ID:-}
      OAUTH_GITHUB_CLIENT_SECRET: ${OAUTH_GITHUB_CLIENT_SECRET:-}
    command: python -m worker.run_worker
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: ${DATABASE_USERNAME}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD}
      POSTGRES_DB: ${DATABASE_NAME}
    volumes:
      - postgres-db:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DATABASE_USERNAME} -d ${DATABASE_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    volumes:
      - redis-data:/data

volumes:
  postgres-db:
  redis-data:
